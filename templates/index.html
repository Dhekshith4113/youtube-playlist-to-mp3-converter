<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Playlist Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background-color: #2c3e50; color: #ecf0f1; margin: 0;}
        .container { background: #34495e; padding: 2.5rem; border-radius: 12px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); text-align: center; width: 500px; }
        
        input[type="text"] { width: 100%; padding: 12px; margin: 15px 0; border: none; border-radius: 6px; box-sizing: border-box; background: #ecf0f1; color: #333;}
        
        /* Buttons */
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; }
        button { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: 0.3s; color: white; }
        .btn-download { background-color: #27ae60; flex: 2; }
        .btn-download:hover { background-color: #2ecc71; }
        .btn-clear { background-color: #7f8c8d; flex: 1; }
        .btn-clear:hover { background-color: #95a5a6; }

        /* Progress Area */
        .progress-wrapper { text-align: left; margin-top: 20px; display: none; }
        
        /* Global Bar (The big one) */
        .global-info { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; color: #3498db; font-weight: bold;}
        .bar-container { width: 100%; background-color: #2c3e50; border: 1px solid #7f8c8d; border-radius: 10px; height: 20px; overflow: hidden; margin-bottom: 15px; }
        .bar-fill { height: 100%; width: 0%; background-color: #3498db; transition: width 0.3s; }

        /* Item Bar (The small one) */
        .item-wrapper { display: none; /* Hidden by default */ }
        .item-info { font-size: 0.8rem; color: #bdc3c7; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-bar-container { width: 100%; background-color: #2c3e50; border: 1px solid #555; border-radius: 6px; height: 8px; overflow: hidden; }
        .item-bar-fill { height: 100%; width: 0%; background-color: #e67e22; transition: width 0.3s; }

        .status-text { margin-top: 15px; font-size: 0.9rem; color: #bdc3c7; min-height: 1.2em; text-align: center; font-style: italic;}
    </style>
</head>
<body>
    <div class="container">
        <h2>YouTube to MP3</h2>
        <input type="text" id="urlInput" placeholder="Paste Playlist URL here...">
        
        <div class="btn-group">
            <button class="btn-download" onclick="startDownload()">Download Playlist</button>
            <button class="btn-clear" onclick="clearHistory()">Clear History</button>
        </div>
        
        <div class="progress-wrapper" id="mainProgressArea">
            
            <div class="global-info">
                <span>Total Progress</span>
                <span id="globalText">0%</span>
            </div>
            <div class="bar-container">
                <div class="bar-fill" id="globalBar"></div>
            </div>

            <div class="item-wrapper" id="itemArea">
                <div class="item-info" id="itemText">Waiting...</div>
                <div class="item-bar-container">
                    <div class="item-bar-fill" id="itemBar"></div>
                </div>
            </div>

        </div>

        <p class="status-text" id="statusLog">Ready.</p>
    </div>

    <script>
        const socket = io();
        const mainArea = document.getElementById('mainProgressArea');
        const itemArea = document.getElementById('itemArea');
        
        // Global elements
        const globalBar = document.getElementById('globalBar');
        const globalText = document.getElementById('globalText');
        
        // Item elements
        const itemBar = document.getElementById('itemBar');
        const itemText = document.getElementById('itemText');
        
        const statusLog = document.getElementById('statusLog');

        function startDownload() {
            const url = document.getElementById('urlInput').value;
            if(!url) { alert("Please enter a URL"); return; }
            
            // Reset UI
            mainArea.style.display = 'block';
            itemArea.style.display = 'none';
            globalBar.style.width = '0%';
            globalText.innerText = '0%';
            statusLog.innerText = "Initializing...";
            
            socket.emit('start_download', {url: url});
        }

        function clearHistory() {
            if(confirm("Clear download history?")) {
                socket.emit('clear_archive');
            }
        }

        socket.on('progress', function(msg) {
            
            // 1. Update Global Bar (Always happens)
            if(msg.global_percent !== undefined) {
                globalBar.style.width = msg.global_percent + '%';
                globalText.innerText = Math.round(msg.global_percent) + '%';
            }

            // 2. Update Item Bar (Only if downloading a song)
            if (msg.type === 'downloading') {
                itemArea.style.display = 'block'; // Make sure it's visible
                itemBar.style.width = msg.current_song_percent + '%';
                itemText.innerText = `Downloading item ${msg.index} of ${msg.total}: ${msg.filename}`;
            } 
            // 3. If processing/zipping, hide the detailed item bar
            else if (msg.type === 'processing' || msg.type === 'zipping') {
                itemBar.style.width = '100%';
                itemText.innerText = "Processing audio...";
                // Optional: Fade out item bar
                // itemArea.style.display = 'none'; 
            }
        });

        socket.on('log', function(msg) {
            statusLog.innerText = msg.data;
        });

        socket.on('done', function(msg) {
            globalBar.style.width = '100%';
            globalText.innerText = '100%';
            itemArea.style.display = 'none'; // Hide item bar when totally done
            statusLog.innerText = "Done! Downloading Zip...";
            window.location.href = msg.url;
        });
    </script>
</body>
</html>